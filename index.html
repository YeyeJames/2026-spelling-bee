
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>單字大師 (Word Hero) - 完整版</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#fffbeb">
    
    <!-- 錯誤處理器 -->
    <script>
      window.onerror = function(msg, url, line, col, error) {
        var div = document.createElement('div');
        div.style.cssText = 'position:fixed; top:0; left:0; width:100%; background:rgba(255,0,0,0.9); color:white; padding:20px; z-index:9999; font-family:monospace; white-space:pre-wrap;';
        div.innerHTML = '<h3>⚠️ 發生錯誤</h3>' + msg + '<br><small>' + url + ':' + line + '</small>';
        document.body.appendChild(div);
        return false;
      };
    </script>

    <!-- 1. 載入函式庫 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@0.344.0/dist/umd/lucide.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
      tailwind.config = {
        darkMode: 'class',
      }
    </script>
    <style>
      body {
        font-family: 'Fredoka', sans-serif;
        transition: background-color 0.3s ease, color 0.3s ease;
        -webkit-tap-highlight-color: transparent;
        overscroll-behavior-y: contain;
      }
      /* Themes */
      .theme-default { background-color: #fffbeb; background-image: radial-gradient(#fde68a 1px, transparent 1px); background-size: 20px 20px; }
      .theme-space { background-color: #0f172a; background-image: radial-gradient(#312e81 1px, transparent 1px); background-size: 30px 30px; color: #e2e8f0; }
      .theme-racing { background-color: #fef2f2; background-image: linear-gradient(45deg, #fee2e2 25%, transparent 25%, transparent 75%, #fee2e2 75%, #fee2e2), linear-gradient(45deg, #fee2e2 25%, transparent 25%, transparent 75%, #fee2e2 75%, #fee2e2); background-size: 20px 20px; background-position: 0 0, 10px 10px; }
      .theme-forest { background-color: #f0fdf4; background-image: radial-gradient(#86efac 1px, transparent 1px); background-size: 24px 24px; }
      
      .dark .theme-default { background-color: #020617; background-image: radial-gradient(#1e293b 1px, transparent 1px); }
      
      @keyframes shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-4px); } 20%, 40%, 60%, 80% { transform: translateX(4px); } }
      .animate-shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
      @keyframes pop-success { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
      .animate-pop { animation: pop-success 0.4s ease-out forwards; }
      @keyframes submit-pulse { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); transform: scale(1); } 50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); transform: scale(0.98); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); transform: scale(1); } }
      .animate-submit-pulse { animation: submit-pulse 0.3s ease-out forwards; }
      
      ::-webkit-scrollbar { width: 10px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: #fbbf24; border-radius: 5px; }
      .dark ::-webkit-scrollbar-thumb { background: #1d4ed8; }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.4",
    "react-dom/": "https://esm.sh/react-dom@^19.2.4/",
    "react/": "https://esm.sh/react@^19.2.4/",
    "@google/genai": "https://esm.sh/@google/genai@^1.38.0",
    "canvas-confetti": "https://esm.sh/canvas-confetti@^1.9.4",
    "lucide-react": "https://esm.sh/lucide-react@^0.563.0",
    "vite": "https://esm.sh/vite@^7.3.1",
    "@vitejs/plugin-react": "https://esm.sh/@vitejs/plugin-react@^5.1.2"
  }
}
</script>
</head>
<body class="antialiased selection:bg-amber-200 selection:text-amber-900 transition-colors duration-300">
    <div id="root">
        <div style="height: 100vh; display: flex; align-items: center; justify-content: center; color: #64748b; font-weight: bold;">
            載入中... (Loading)
        </div>
    </div>

    <script type="text/babel">
        try {
            const { useState, useEffect, useRef, useCallback, useMemo } = React;

            // --- ICONS 處理 ---
            const Icon = ({ name, size = 24, className = "", fill = "none" }) => {
                const lucideGlobal = window.lucide;
                if (!lucideGlobal) return <span style={{fontSize: '12px', color: '#64748b'}}>?</span>;

                const iconDef = lucideGlobal.icons[name];
                if (!iconDef) {
                    return <span className={className} style={{ width: size, height: size, display: 'inline-block', border: '2px dashed currentColor', borderRadius: '50%', opacity: 0.5 }}></span>;
                }

                try {
                    const svgElement = lucideGlobal.createElement(iconDef);
                    svgElement.setAttribute('width', size);
                    svgElement.setAttribute('height', size);
                    if (className) svgElement.setAttribute('class', className);
                    svgElement.setAttribute('fill', fill === "currentColor" ? "currentColor" : "none");
                    svgElement.setAttribute('stroke', "currentColor");
                    svgElement.setAttribute('stroke-width', "2.5");
                    svgElement.setAttribute('stroke-linecap', "round");
                    svgElement.setAttribute('stroke-linejoin', "round");
                    return <span dangerouslySetInnerHTML={{ __html: svgElement.outerHTML }} style={{ display: 'inline-flex', verticalAlign: 'middle' }} />;
                } catch (e) {
                    return null;
                }
            };

            const LucideIconProxy = new Proxy({}, {
                get: (target, prop) => (props) => <Icon name={prop} {...props} />
            });

            // 解構常用圖標
            const { 
                Zap, User, Volume2, ArrowRight, ArrowLeft, CheckCircle, XCircle, HelpCircle, 
                Clock, Flame, ShieldCheck, Shuffle, ListOrdered, Mic, Square, Play,
                Settings, Music, Music2, Sun, Moon, LogIn, Bookmark, Library, Book, Sparkles,
                Bot, Rocket, Ghost, Crown, Star, ShoppingBag, Award, History, Coins, Trophy,
                AlertCircle, GraduationCap, AlertTriangle, FastForward, Briefcase, Utensils, Film, Plane,
                Laptop, Gamepad2, Bike, Bomb, Compass, Shield, Sword, Map, Anchor, Bug, Gift, Heart,
                Palette, TreeDeciduous, Flower2, Gem, Cpu, Cloud,
                Cat, Dog, Bird, Rabbit, Smile,
                Headphones, Globe, Languages, Clover, Wind, LayoutGrid, Check
            } = LucideIconProxy;

            // --- 資料層 ---
            const PART_1_WORDS = [
                { word: "accompany", definition: "(v.) 陪伴；伴隨", englishDefinition: "To go somewhere with someone.", example: "I will accompany my grandmother to the doctor tomorrow. 我明天會陪祖母去看醫生。" },
                { word: "alder", definition: "(n.) 榿木", englishDefinition: "A type of tree that often grows near water.", example: "The bird built a small nest in the tall alder tree. 那隻鳥在那棵高大的榿木上築了一個小巢。" },
                { word: "adventure", definition: "(n.) 冒險", englishDefinition: "An exciting and sometimes dangerous experience.", example: "Life is full of surprises and adventures if you are brave enough. 如果你夠勇敢，生活中充滿了驚喜與冒險。" },
                { word: "amphibian", definition: "(n.) 兩棲動物", englishDefinition: "An animal (like a frog) that can live both on land and in water.", example: "Frogs are the most common type of amphibian found in this area. 青蛙是這個地區最常見的兩棲動物。" },
                { word: "ancient", definition: "(adj.) 古代的；古老的", englishDefinition: "Very old; from a long time ago.", example: "We visited the ancient ruins in Rome during our summer vacation. 我們在暑假期間參觀了羅馬的古代遺跡。" },
                { word: "appeal", definition: "(v./n.) 吸引；呼籲", englishDefinition: "To be interesting or attractive to someone.", example: "The idea of camping in the rain doesn't appeal to me at all. 在雨中露營的想法對我一點吸引力都沒有。" },
                { word: "appoint", definition: "(v.) 指派；任命", englishDefinition: "To choose someone for a job or position.", example: "The teacher decided to appoint John as the class leader. 老師決定指派約翰擔任班長。" },
                { word: "arithmetic", definition: "(n.) 算術", englishDefinition: "The math of adding, subtracting, multiplying, and dividing numbers.", example: "Mental arithmetic is a very useful skill for shopping. 心算對於購物來說是一項很有用的技能。" },
                { word: "arrangement", definition: "(n.) 安排；佈置", englishDefinition: "The way things are organized or placed.", example: "The flower arrangement on the table looks absolutely beautiful. 桌上的花藝佈置看起來美極了。" },
                { word: "atop", definition: "(prep.) 在...頂上", englishDefinition: "On the top of something.", example: "The cat sat atop the wall, watching the birds fly by. 貓咪坐在牆頭上，看著鳥兒飛過。" }
            ];
            // (Simulated full list for brevity, in real app add all)
            const FULL_WORD_LIST = [...PART_1_WORDS];

            const ACHIEVEMENTS = [
                { id: 'first_win', title: '英雄初現', description: '完成第一次挑戰任務', icon: 'Zap', condition: (records) => records.length >= 1 },
                { id: 'perfect_accuracy', title: '精準之刃', description: '在一場挑戰中獲得 100% 正確率', icon: 'Target', condition: (records) => records.some(r => r.stats.correct === r.stats.total && r.stats.total > 0) },
                { id: 'marathon', title: '毅力長征', description: '累積完成 10 次挑戰任務', icon: 'Flag', condition: (records) => records.length >= 10 },
                { id: 'wealthy', title: '金幣富翁', description: '累積獲得超過 500 枚代幣', icon: 'Coins', condition: (_, tokens) => tokens >= 500 },
                { id: 'collector', title: '收集達人', description: '擁有超過 3 個商店物品', icon: 'ShoppingBag', condition: (_, __, profile) => (profile?.purchasedItemIds?.length || 0) >= 3 },
            ];
            
            const SHOP_ITEMS = [
                { id: 'av_bot', name: '智核機器人', price: 100, type: 'avatar', iconName: 'Bot', color: 'bg-indigo-500', category: 'tech' },
                { id: 'av_rocket', name: '星際火箭', price: 150, type: 'avatar', iconName: 'Rocket', color: 'bg-orange-500', category: 'tech' },
                { id: 'av_ghost', name: '頑皮幽靈', price: 200, type: 'avatar', iconName: 'Ghost', color: 'bg-purple-600', category: 'rare' },
                { id: 'av_crown', name: '王者之冠', price: 500, type: 'avatar', iconName: 'Crown', color: 'bg-amber-400', category: 'rare' },
                { id: 'theme-space', name: '無盡太空', price: 300, type: 'theme', iconName: 'Moon', color: 'bg-indigo-900', category: 'theme' },
                { id: 'theme-forest', name: '原始森林', price: 250, type: 'theme', iconName: 'TreeDeciduous', color: 'bg-emerald-800', category: 'theme' },
            ];

            const AVATARS = [
                { id: 'user', icon: User, color: 'bg-blue-500' },
                { id: 'cat', icon: Cat, color: 'bg-rose-500' },
                { id: 'dog', icon: Dog, color: 'bg-amber-500' },
                { id: 'bird', icon: Bird, color: 'bg-sky-500' },
                { id: 'rabbit', icon: Rabbit, color: 'bg-purple-500' },
                { id: 'smile', icon: Smile, color: 'bg-emerald-500' },
                ...SHOP_ITEMS.filter(i => i.type === 'avatar').map(i => ({ id: i.id, icon: LucideIconProxy[i.iconName], color: i.color }))
            ];

            // --- UTILS (服務層) ---
            const CURRENT_USER_KEY = 'dictation_master_current_user';
            
            const getCurrentUser = () => localStorage.getItem(CURRENT_USER_KEY);
            const getUserKey = (suffix) => {
                const user = getCurrentUser();
                return user ? `user_${user}${suffix}` : null;
            };

            const loginUser = (username) => {
                localStorage.setItem(CURRENT_USER_KEY, username);
                let profile = getUserProfile();
                if (!profile) {
                    profile = { username, avatarId: 'user', activeThemeId: 'theme-default', purchasedItemIds: [] };
                    saveUserProfile(profile);
                }
                return profile;
            };
            const logoutUser = () => localStorage.removeItem(CURRENT_USER_KEY);
            
            const getUserProfile = () => {
                const key = getUserKey('_profile');
                if (!key) return null;
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : null;
            };
            const saveUserProfile = (profile) => {
                const key = getUserKey('_profile');
                if (key) localStorage.setItem(key, JSON.stringify(profile));
            };

            const getUserTokens = () => {
                const key = getUserKey('_tokens');
                if (!key) return 0;
                return parseInt(localStorage.getItem(key) || '0', 10);
            };
            const addUserTokens = (amount) => {
                const key = getUserKey('_tokens');
                if (!key) return 0;
                const newTotal = getUserTokens() + amount;
                localStorage.setItem(key, newTotal.toString());
                return newTotal;
            };
            const deductUserTokens = (amount) => {
                const key = getUserKey('_tokens');
                if (!key) return false;
                const current = getUserTokens();
                if (current < amount) return false;
                localStorage.setItem(key, (current - amount).toString());
                return true;
            };

            const purchaseItem = (itemId, price) => {
                const profile = getUserProfile();
                if (!profile) return false;
                if (deductUserTokens(price)) {
                    const updated = { ...profile, purchasedItemIds: [...(profile.purchasedItemIds || []), itemId] };
                    saveUserProfile(updated);
                    return true;
                }
                return false;
            };

            const saveUserRecording = (word, base64) => {
                const key = getUserKey(`_rec_${word.toLowerCase()}`);
                if(key) {
                    try { localStorage.setItem(key, base64); } 
                    catch(e) { console.error("Storage full?", e); }
                }
            };
            const getUserRecording = (word) => {
                const key = getUserKey(`_rec_${word.toLowerCase()}`);
                return key ? localStorage.getItem(key) : null;
            };

            const getGameRecords = () => {
                const key = getUserKey('_history');
                if (!key) return [];
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : [];
            };
            const saveGameRecord = (record) => {
                const key = getUserKey('_history');
                if (!key) return;
                const existing = getGameRecords();
                localStorage.setItem(key, JSON.stringify([record, ...existing].slice(0, 100)));
            };

            const playSound = (type) => {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;
                const ctx = new AudioContext();
                const now = ctx.currentTime;
                
                if (type === 'correct') {
                    const freqs = [1046, 1318, 1568, 2093];
                    freqs.forEach((f, i) => {
                        const osc = ctx.createOscillator();
                        const g = ctx.createGain();
                        osc.frequency.value = f;
                        const t = now + i * 0.02;
                        osc.connect(g); g.connect(ctx.destination);
                        g.gain.setValueAtTime(0, t);
                        g.gain.linearRampToValueAtTime(0.08, t + 0.01);
                        g.gain.exponentialRampToValueAtTime(0.001, t + 0.6);
                        osc.start(t); osc.stop(t + 0.6);
                    });
                } else if (type === 'incorrect') {
                    const osc = ctx.createOscillator();
                    const g = ctx.createGain();
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(150, now);
                    osc.frequency.linearRampToValueAtTime(100, now + 0.3);
                    osc.connect(g); g.connect(ctx.destination);
                    g.gain.setValueAtTime(0.1, now);
                    g.gain.linearRampToValueAtTime(0, now + 0.3);
                    osc.start(now); osc.stop(now + 0.3);
                } else if (type === 'next') {
                    const osc = ctx.createOscillator();
                    const g = ctx.createGain();
                    osc.frequency.setValueAtTime(400, now);
                    osc.frequency.exponentialRampToValueAtTime(800, now + 0.2);
                    osc.connect(g); g.connect(ctx.destination);
                    g.gain.setValueAtTime(0.05, now);
                    g.gain.linearRampToValueAtTime(0, now + 0.2);
                    osc.start(now); osc.stop(now + 0.2);
                }
            };

            // --- UI 元件 ---
            const Button = ({ children, variant = 'primary', className = '', ...props }) => {
                const variants = {
                    primary: "bg-blue-500 text-white border-blue-700 shadow-blue-200 dark:shadow-blue-900/20 hover:bg-blue-400 hover:border-blue-600",
                    secondary: "bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-200 border-slate-300 dark:border-slate-700 shadow-slate-200 dark:shadow-none hover:border-slate-400 dark:hover:border-slate-600 hover:text-blue-600 dark:hover:text-blue-400",
                    danger: "bg-rose-500 text-white border-rose-700 shadow-rose-200 dark:shadow-rose-900/20 hover:bg-rose-400"
                };
                return (
                    <button className={`px-6 py-3 rounded-xl font-bold transition-all duration-150 flex items-center justify-center gap-2 transform active:translate-y-1 active:shadow-none disabled:opacity-50 disabled:cursor-not-allowed border-b-4 select-none ${variants[variant]} ${className}`} {...props}>
                        {children}
                    </button>
                );
            };

            const ControlBtn = ({ onClick, icon, label, disabled, color = 'text-slate-600 dark:text-slate-300', small = false }) => (
                <button 
                    onClick={onClick} 
                    disabled={disabled}
                    className={`flex flex-col items-center justify-center rounded-xl transition-all active:translate-y-1 active:border-b-0 disabled:opacity-20 disabled:grayscale 
                    ${small ? 'p-1.5 min-w-[32px] bg-slate-50 dark:bg-slate-800/50 border-slate-100 dark:border-slate-700' : 'p-2 min-w-[44px] bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 shadow-sm'}
                    border-b-2`}
                >
                    <div className={color}>{icon}</div>
                    {!small && <span className="text-[9px] font-black uppercase mt-1 tracking-tighter text-slate-400">{label}</span>}
                </button>
            );

            const ProgressBar = ({ current, total }) => {
                const percentage = Math.min(100, Math.max(0, (current / total) * 100));
                return (
                    <div className="w-full">
                        <div className="flex justify-between text-xs font-black text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">
                            <span>關卡進度</span>
                            <span className="text-blue-700 dark:text-blue-400">{current} / {total}</span>
                        </div>
                        <div className="h-5 w-full bg-slate-200 dark:bg-slate-800 rounded-full overflow-hidden border-2 border-slate-300 dark:border-slate-700">
                            <div className="h-full bg-gradient-to-r from-blue-400 to-blue-500 transition-all duration-500 ease-out" style={{ width: `${percentage}%` }} />
                        </div>
                    </div>
                );
            };

            // --- Views ---

            const ShopView = ({ onBack, onUpdateTokens }) => {
                const [tokens, setTokens] = useState(getUserTokens());
                const [profile, setProfile] = useState(getUserProfile());
                const [currentCategory, setCurrentCategory] = useState('all');
                const [message, setMessage] = useState(null);

                const filteredItems = currentCategory === 'all' ? SHOP_ITEMS : SHOP_ITEMS.filter(i => i.category === currentCategory);

                const handlePurchase = (item) => {
                    if (tokens < item.price) {
                        setMessage({ text: '代幣不足！', type: 'error' });
                        setTimeout(() => setMessage(null), 2000);
                        return;
                    }
                    if (purchaseItem(item.id, item.price)) {
                        setTokens(getUserTokens());
                        setProfile(getUserProfile());
                        onUpdateTokens();
                        setMessage({ text: `解鎖 ${item.name}！`, type: 'success' });
                        setTimeout(() => setMessage(null), 2000);
                    }
                };

                const handleEquip = (item) => {
                    if (!profile) return;
                    const updated = item.type === 'avatar' ? { ...profile, avatarId: item.id } : { ...profile, activeThemeId: item.id };
                    saveUserProfile(updated);
                    setProfile(updated);
                    setMessage({ text: `已裝備 ${item.name}`, type: 'success' });
                    setTimeout(() => setMessage(null), 2000);
                };

                return (
                    <div className="flex-1 flex flex-col p-4 w-full max-w-5xl mx-auto animate-in slide-in-from-right-4">
                        <div className="flex items-center justify-between mb-6">
                            <button onClick={onBack} className="text-slate-500 hover:text-blue-600 font-black flex items-center gap-1"><ArrowLeft size={20} /> 返回</button>
                            <div className="flex items-center gap-2 bg-white/80 border-2 border-amber-200 px-4 py-2 rounded-xl shadow-sm">
                                <Coins size={20} className="text-amber-500" />
                                <span className="font-black text-amber-700 text-lg">{tokens}</span>
                            </div>
                        </div>
                        
                        <div className="text-center mb-8">
                            <h2 className="text-4xl font-black text-slate-800 dark:text-slate-100 flex justify-center gap-2 items-center"><ShoppingBag className="text-blue-500"/> 英雄商店</h2>
                        </div>

                        {message && (
                            <div className={`mb-6 p-3 rounded-xl text-center font-bold ${message.type === 'success' ? 'bg-emerald-100 text-emerald-700' : 'bg-rose-100 text-rose-700'}`}>
                                {message.text}
                            </div>
                        )}

                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 pb-20">
                            {filteredItems.map(item => {
                                const isPurchased = profile?.purchasedItemIds?.includes(item.id);
                                const isEquipped = item.type === 'avatar' ? profile?.avatarId === item.id : profile?.activeThemeId === item.id;
                                const IconComp = LucideIconProxy[item.iconName] || Bot;
                                
                                return (
                                    <div key={item.id} className={`p-4 rounded-3xl border-4 flex flex-col items-center gap-3 relative ${isEquipped ? 'bg-blue-50 border-blue-400' : 'bg-white border-slate-100'}`}>
                                        {isEquipped && <div className="absolute top-2 right-2 text-blue-500"><CheckCircle size={20} fill="currentColor" className="text-white"/></div>}
                                        <div className={`w-16 h-16 rounded-2xl flex items-center justify-center text-white ${item.color}`}>
                                            <IconComp size={32} />
                                        </div>
                                        <div className="text-center">
                                            <div className="font-black text-slate-800">{item.name}</div>
                                            {!isPurchased && <div className="text-xs font-bold text-amber-600 flex items-center justify-center gap-1"><Coins size={12}/> {item.price}</div>}
                                        </div>
                                        {!isPurchased ? (
                                            <button onClick={() => handlePurchase(item)} disabled={tokens < item.price} className="w-full py-2 bg-slate-900 text-white rounded-xl text-xs font-black">購買</button>
                                        ) : (
                                            <button onClick={() => handleEquip(item)} disabled={isEquipped} className={`w-full py-2 rounded-xl text-xs font-black ${isEquipped ? 'bg-blue-100 text-blue-500' : 'bg-emerald-500 text-white'}`}>
                                                {isEquipped ? '使用中' : '裝備'}
                                            </button>
                                        )}
                                    </div>
                                )
                            })}
                        </div>
                    </div>
                );
            };

            const AchievementsView = ({ onBack }) => {
                const unlocked = getGameRecords().length; // Simplified for demo
                const records = getGameRecords();
                const tokens = getUserTokens();
                const profile = getUserProfile();

                return (
                    <div className="flex-1 flex flex-col p-4 w-full max-w-4xl mx-auto animate-in slide-in-from-right-4">
                        <button onClick={onBack} className="mb-6 text-slate-500 hover:text-blue-600 font-black flex items-center gap-1"><ArrowLeft size={20} /> 返回</button>
                        <h2 className="text-4xl font-black text-center mb-8 text-slate-800 dark:text-slate-100 flex justify-center gap-2"><Trophy className="text-amber-500"/> 成就獎章</h2>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {ACHIEVEMENTS.map(ach => {
                                const isUnlocked = ach.condition(records, tokens, profile);
                                const AchIcon = LucideIconProxy[ach.icon] || Zap;
                                return (
                                    <div key={ach.id} className={`p-4 rounded-2xl border-4 flex items-center gap-4 ${isUnlocked ? 'bg-white border-amber-200 shadow-sm' : 'bg-slate-50 border-slate-100 opacity-60'}`}>
                                        <div className={`p-3 rounded-xl ${isUnlocked ? 'bg-amber-100 text-amber-600' : 'bg-slate-200 text-slate-400'}`}>
                                            <AchIcon size={24} />
                                        </div>
                                        <div>
                                            <h3 className={`font-black text-lg ${isUnlocked ? 'text-slate-800' : 'text-slate-400'}`}>{ach.title}</h3>
                                            <p className="text-xs font-bold text-slate-500">{ach.description}</p>
                                        </div>
                                        {isUnlocked && <CheckCircle size={24} className="ml-auto text-emerald-500" fill="#ecfdf5"/>}
                                    </div>
                                )
                            })}
                        </div>
                    </div>
                );
            };

            const DictationGame = ({ words, onFinish, onExit, onTokenEarned }) => {
                const [currentIndex, setCurrentIndex] = useState(0);
                const [isRandom, setIsRandom] = useState(true);
                const [playList, setPlayList] = useState([]);
                const [userInput, setUserInput] = useState('');
                const [feedback, setFeedback] = useState('idle');
                const [showHint, setShowHint] = useState(false);
                const [streak, setStreak] = useState(0);
                const [stats, setStats] = useState({ correct: 0, incorrect: 0, total: words.length, history: [] });
                const [elapsedTime, setElapsedTime] = useState(0);
                const [animationClass, setAnimationClass] = useState('');
                
                // Recording States
                const [isRecording, setIsRecording] = useState(false);
                const [userRecordingUrl, setUserRecordingUrl] = useState(null);
                const mediaRecorderRef = useRef(null);
                const audioChunksRef = useRef([]);
                
                const inputRef = useRef(null);
                const startTimeRef = useRef(Date.now());

                useEffect(() => {
                    let initialList = [...words];
                    if (isRandom) initialList.sort(() => 0.5 - Math.random());
                    setPlayList(initialList);
                }, [words]);

                useEffect(() => {
                    startTimeRef.current = Date.now();
                    const timer = setInterval(() => setElapsedTime(Math.floor((Date.now() - startTimeRef.current) / 1000)), 1000);
                    return () => clearInterval(timer);
                }, []);

                const currentWord = playList[currentIndex] || words[0];

                // Load existing recording for this word
                useEffect(() => {
                    if (currentWord) {
                        const existing = getUserRecording(currentWord.word);
                        setUserRecordingUrl(existing);
                    }
                }, [currentWord]);

                const speakWord = useCallback((text, rate = 0.9, langType = 'US') => {
                    window.speechSynthesis.cancel();
                    const u = new SpeechSynthesisUtterance(text);
                    let targetRate = rate;
                    let targetPitch = 1.0;
                    let targetLang = 'en-US';

                    if (langType === 'GB') targetLang = 'en-GB';
                    else if (langType === 'AU') targetLang = 'en-AU';
                    else if (langType === 'IN') targetLang = 'en-IN'; // Attempt Indian accent
                    else if (langType === 'IE') targetLang = 'en-IE'; // Attempt Irish
                    else if (langType === 'KID') { targetPitch = 1.4; targetRate = 1.1; }
                    else if (langType === 'MONSTER') { targetPitch = 0.6; targetRate = 0.8; }
                    else if (langType === 'SLOW') targetRate = 0.5;
                    else if (langType === 'FAST') targetRate = 1.4;

                    u.lang = targetLang;
                    u.rate = targetRate;
                    u.pitch = targetPitch;
                    
                    // Try to find matching voice
                    const voices = window.speechSynthesis.getVoices();
                    let voice = null;
                    if(langType === 'GB') voice = voices.find(v => v.lang.includes('GB') || v.name.includes('UK'));
                    else if(langType === 'AU') voice = voices.find(v => v.lang.includes('AU'));
                    else if(langType === 'IN') voice = voices.find(v => v.lang.includes('IN'));
                    
                    if(voice) u.voice = voice;
                    
                    window.speechSynthesis.speak(u);
                }, []);

                useEffect(() => {
                    if(currentWord) setTimeout(() => { speakWord(currentWord.word); inputRef.current?.focus(); }, 500);
                }, [currentWord]);

                // Recording Logic
                const startRecording = async () => {
                    if (!navigator.mediaDevices) return alert("您的裝置不支援錄音");
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        const mediaRecorder = new MediaRecorder(stream);
                        mediaRecorderRef.current = mediaRecorder;
                        audioChunksRef.current = [];
                        mediaRecorder.ondataavailable = e => audioChunksRef.current.push(e.data);
                        mediaRecorder.onstop = () => {
                            const blob = new Blob(audioChunksRef.current, { type: 'audio/webm' });
                            const reader = new FileReader();
                            reader.readAsDataURL(blob);
                            reader.onloadend = () => {
                                const base64 = reader.result;
                                saveUserRecording(currentWord.word, base64);
                                setUserRecordingUrl(base64);
                            }
                            stream.getTracks().forEach(t => t.stop());
                        };
                        mediaRecorder.start();
                        setIsRecording(true);
                    } catch(e) {
                        alert("無法存取麥克風");
                    }
                };

                const stopRecording = () => {
                    if(mediaRecorderRef.current) {
                        mediaRecorderRef.current.stop();
                        setIsRecording(false);
                    }
                };

                const playMyRecording = () => {
                    if(userRecordingUrl) {
                        const audio = new Audio(userRecordingUrl);
                        audio.play();
                    }
                };

                const handleSubmit = () => {
                    if (!userInput.trim()) return;
                    const isCorrect = userInput.trim().toLowerCase() === currentWord.word.toLowerCase();
                    setAnimationClass('animate-submit-pulse border-blue-400');
                    
                    setTimeout(() => {
                        if (isCorrect) {
                            setStreak(s => s + 1);
                            playSound('correct');
                            setAnimationClass('animate-pop border-emerald-500 text-emerald-600 bg-emerald-50 dark:bg-emerald-900/20');
                            addUserTokens(10);
                            if(onTokenEarned) onTokenEarned(10);
                            if (window.confetti) confetti({ particleCount: 80, spread: 70, origin: { y: 0.7 }, colors: ['#3b82f6', '#fbbf24', '#10b981'] });
                            speakWord("Correct!");
                            setTimeout(() => {
                                setFeedback('correct');
                                setStats(p => ({ ...p, correct: p.correct + 1, history: [...p.history, { word: currentWord.word, isCorrect: true, userSpelling: userInput }] }));
                                setAnimationClass('');
                            }, 500);
                        } else {
                            setStreak(0);
                            playSound('incorrect');
                            setAnimationClass('animate-shake border-rose-400 text-rose-500 bg-rose-50 dark:bg-rose-900/20');
                            speakWord(`Incorrect. The word is ${currentWord.word}`);
                            setTimeout(() => {
                                setFeedback('incorrect');
                                setStats(p => ({ ...p, incorrect: p.incorrect + 1, history: [...p.history, { word: currentWord.word, isCorrect: false, userSpelling: userInput }] }));
                                setAnimationClass('');
                            }, 500);
                        }
                    }, 300);
                };

                const handleNext = useCallback(() => {
                    playSound('next');
                    if (currentIndex < words.length - 1) {
                        setCurrentIndex(p => p + 1);
                        setUserInput('');
                        setFeedback('idle');
                        setShowHint(false);
                        setUserRecordingUrl(null);
                    } else {
                        onFinish({ ...stats, duration: elapsedTime });
                    }
                }, [currentIndex, words.length, stats, elapsedTime, onFinish]);

                useEffect(() => {
                    const handleKey = (e) => {
                        if (feedback !== 'idle' && (e.key === 'Enter' || e.key === ' ')) {
                            e.preventDefault();
                            handleNext();
                        }
                    };
                    window.addEventListener('keydown', handleKey);
                    return () => window.removeEventListener('keydown', handleKey);
                }, [feedback, handleNext]);

                if (!currentWord) return null;

                return (
                    <div className="max-w-4xl mx-auto px-2 py-4 flex flex-col justify-center min-h-[80vh]">
                        <div className="mb-2 flex items-center justify-between gap-4">
                            <button onClick={onExit} className="text-slate-500 hover:text-slate-700 text-xs font-black flex items-center gap-1"><ArrowLeft size={14} /> EXIT</button>
                            <div className="flex-1 max-w-xs"><ProgressBar current={currentIndex + 1} total={words.length} /></div>
                            <button onClick={() => setIsRandom(!isRandom)} disabled={feedback !== 'idle'} className="px-3 py-1.5 rounded-lg text-xs font-black bg-blue-100 text-blue-700 flex items-center gap-1 border border-blue-200">
                                {isRandom ? <Shuffle size={14} /> : <ListOrdered size={14} />} {isRandom ? "隨機" : "順序"}
                            </button>
                        </div>

                        <div className="bg-white dark:bg-slate-900 rounded-[2rem] shadow-xl border-4 border-slate-200 dark:border-slate-800 p-6 flex flex-col gap-4 relative">
                            <div className="flex flex-col items-center">
                                {streak > 2 && feedback === 'idle' && <div className="text-orange-500 font-black text-lg animate-bounce mb-1 flex items-center gap-2"><Flame size={20} fill="currentColor" /> {streak} COMBO</div>}
                                
                                {feedback === 'idle' ? (
                                    <div className="flex items-center gap-2 w-full max-w-md">
                                        <input ref={inputRef} type="text" value={userInput} onChange={e => setUserInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleSubmit()} placeholder="Listen & Type..." className={`w-full text-center text-4xl font-black border-b-2 border-slate-300 dark:border-slate-700 focus:border-blue-500 focus:outline-none py-4 bg-transparent placeholder-slate-300 dark:placeholder-slate-600 transition-all ${animationClass}`} autoComplete="off" />
                                        <button onClick={() => setShowHint(!showHint)} className="p-3 rounded-xl bg-slate-100 border-2 border-slate-200 text-slate-500 hover:border-amber-400 hover:text-amber-600 transition-all"><HelpCircle size={24} /></button>
                                    </div>
                                ) : (
                                    <div className={`text-5xl font-black py-4 flex items-center gap-3 animate-in zoom-in ${feedback === 'correct' ? 'text-emerald-500' : 'text-rose-500'}`}>
                                        {feedback === 'correct' ? <ShieldCheck size={48} /> : <XCircle size={48} />}
                                        {currentWord.word}
                                    </div>
                                )}

                                <div className="mt-4 grid grid-cols-3 gap-3 w-full max-w-md">
                                    <div className="bg-slate-100 dark:bg-slate-800 p-2 rounded-2xl border-b-4 border-slate-300 dark:border-slate-700 text-center"><div className="text-[10px] text-slate-500 font-black">TIME</div><div className="text-xl font-black text-slate-700 dark:text-slate-300 flex justify-center items-center gap-1"><Clock size={16}/> {Math.floor(elapsedTime / 60)}:{String(elapsedTime % 60).padStart(2, '0')}</div></div>
                                    <div className="bg-emerald-100 dark:bg-emerald-900/30 p-2 rounded-2xl border-b-4 border-emerald-200 text-center"><div className="text-[10px] text-emerald-700 font-black">OK</div><div className="text-xl font-black text-emerald-600 flex justify-center items-center gap-1"><CheckCircle size={16}/> {stats.correct}</div></div>
                                    <div className="bg-rose-100 dark:bg-rose-900/30 p-2 rounded-2xl border-b-4 border-rose-200 text-center"><div className="text-[10px] text-rose-700 font-black">ERR</div><div className="text-xl font-black text-rose-600 flex justify-center items-center gap-1"><XCircle size={16}/> {stats.incorrect}</div></div>
                                </div>
                            </div>

                            {(showHint || feedback !== 'idle') && (
                                <div className={`p-4 rounded-2xl border-2 w-full max-w-xl mx-auto animate-in fade-in zoom-in ${feedback !== 'idle' ? 'bg-slate-50 border-slate-300 dark:border-slate-700' : 'bg-amber-50 border-amber-200'}`}>
                                    <p className="text-xs font-black uppercase tracking-widest mb-1 opacity-70 text-slate-600">DEFINITION</p>
                                    <p className="text-2xl font-black mb-2 text-slate-800 dark:text-slate-100">{currentWord.definition}</p>
                                    {feedback !== 'idle' && <p className="text-slate-600 dark:text-slate-400 italic font-medium">"{currentWord.example}"</p>}
                                </div>
                            )}

                            <div className="mt-2">
                                {feedback === 'idle' ? (
                                    <Button onClick={handleSubmit} disabled={!userInput} className="w-full text-xl py-4 rounded-2xl shadow-md">CHECK SPELLING</Button>
                                ) : (
                                    <Button onClick={handleNext} className="w-full text-xl py-4 rounded-2xl bg-emerald-500 border-emerald-700 hover:bg-emerald-400">NEXT WORD <ArrowRight size={20} /></Button>
                                )}
                            </div>
                            
                            {/* Voice & Recording Controls */}
                            <div className="mt-4 bg-slate-50 dark:bg-slate-800/50 p-3 rounded-2xl border-2 border-slate-100 dark:border-slate-700">
                                <div className="grid grid-cols-5 md:grid-cols-9 gap-2 mb-3">
                                    <ControlBtn onClick={() => speakWord(currentWord.word, 0.9, 'US')} icon={<Volume2 size={16}/>} label="US" color="text-blue-500"/>
                                    <ControlBtn onClick={() => speakWord(currentWord.word, 0.9, 'GB')} icon={<Headphones size={16}/>} label="UK" />
                                    <ControlBtn onClick={() => speakWord(currentWord.word, 0.9, 'AU')} icon={<Globe size={16}/>} label="AU" />
                                    <ControlBtn onClick={() => speakWord(currentWord.word, 0.9, 'IN')} icon={<Languages size={16}/>} label="IN" />
                                    <ControlBtn onClick={() => speakWord(currentWord.word, 0.9, 'IE')} icon={<Clover size={16}/>} label="IE" />
                                    <ControlBtn onClick={() => speakWord(currentWord.word, 0.5, 'SLOW')} icon={<Zap size={16} className="rotate-180"/>} label="Slow" />
                                    <ControlBtn onClick={() => speakWord(currentWord.word, 1.4, 'FAST')} icon={<Wind size={16}/>} label="Fast" />
                                    <ControlBtn onClick={() => speakWord(currentWord.word, 1.1, 'KID')} icon={<Sparkles size={16}/>} label="Kid" />
                                    <ControlBtn onClick={() => speakWord(currentWord.word, 0.8, 'MONSTER')} icon={<Ghost size={16}/>} label="Monst" />
                                </div>
                                <div className="flex justify-between items-center bg-white dark:bg-slate-800 p-2 rounded-xl border border-slate-200 dark:border-slate-700">
                                    <div className="flex items-center gap-2">
                                        <button onClick={isRecording ? stopRecording : startRecording} className={`flex items-center gap-2 px-4 py-2 rounded-lg font-bold text-xs border-b-2 transition-all active:scale-95 ${isRecording ? 'bg-rose-500 text-white border-rose-700 animate-pulse' : 'bg-slate-100 text-slate-600 border-slate-300'}`}>
                                            {isRecording ? <><Square size={12} fill="currentColor"/> 錄音中</> : <><Mic size={14}/> 錄音</>}
                                        </button>
                                        {userRecordingUrl && !isRecording && (
                                            <button onClick={playMyRecording} className="p-2 bg-emerald-500 text-white rounded-lg border-b-2 border-emerald-700 active:scale-95 hover:bg-emerald-400">
                                                <Play size={14} fill="currentColor" />
                                            </button>
                                        )}
                                    </div>
                                    <span className="text-[10px] font-bold text-slate-400">{userRecordingUrl ? '已儲存你的發音' : '尚未錄音'}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const App = () => {
                const [gameState, setGameState] = useState('PROFILE_SETUP'); 
                const [words, setWords] = useState(PART_1_WORDS);
                const [profile, setProfile] = useState(null);
                const [userTokens, setUserTokens] = useState(0);
                const [tempUsername, setTempUsername] = useState('');
                const [gameStats, setGameStats] = useState(null);
                const [currentPart, setCurrentPart] = useState('');
                const [isDarkMode, setIsDarkMode] = useState(false);

                useEffect(() => {
                    const user = getCurrentUser();
                    if (user) {
                        setProfile(getUserProfile());
                        setUserTokens(getUserTokens());
                        setGameState('MENU');
                    }
                    if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                        setIsDarkMode(true);
                        document.documentElement.classList.add('dark');
                    }
                }, []);

                const toggleDarkMode = () => {
                    setIsDarkMode(!isDarkMode);
                    document.documentElement.classList.toggle('dark');
                };

                const handleLogin = () => {
                    if (!tempUsername.trim()) return;
                    setProfile(loginUser(tempUsername.trim()));
                    setUserTokens(getUserTokens());
                    setGameState('MENU');
                };

                const startGame = (partNum) => {
                    // In real app select correct word list
                    const partWords = [PART_1_WORDS][0]; 
                    setWords(partWords);
                    setCurrentPart(`Grade 3C - Part ${partNum}`);
                    setGameState('PLAYING');
                };

                const handleGameFinish = (stats) => {
                    setGameStats(stats);
                    saveGameRecord({ id: Date.now().toString(), timestamp: Date.now(), topic: currentPart, stats });
                    setUserTokens(getUserTokens());
                    setGameState('SUMMARY');
                };

                const AvatarIcon = ({ id }) => {
                    const av = AVATARS.find(a => a.id === id) || AVATARS[0];
                    return React.createElement(av.icon, { size: 36, className: "text-white" });
                };

                return (
                    <div className={`min-h-screen flex flex-col font-sans transition-colors duration-300 ${isDarkMode ? 'dark:bg-slate-950 text-slate-100' : 'bg-amber-50 text-slate-800'} ${profile?.activeThemeId || 'theme-default'}`}>
                        <header className="bg-white/90 dark:bg-slate-900/90 backdrop-blur-md border-b-4 border-slate-200/50 sticky top-0 z-20 shadow-sm">
                            <div className="max-w-5xl mx-auto px-4 h-24 flex items-center justify-between relative">
                                <div className="flex items-center gap-4 z-10">
                                    {profile ? (
                                        <div className={`w-16 h-16 rounded-3xl flex items-center justify-center shadow-lg border-4 border-white ${AVATARS.find(a => a.id === profile.avatarId)?.color || 'bg-blue-500'}`} onClick={() => setGameState('PROFILE')}>
                                            <AvatarIcon id={profile.avatarId} />
                                        </div>
                                    ) : <div className="bg-blue-500 text-white p-3 rounded-2xl"><Zap size={32} /></div>}
                                    <div className="flex flex-col cursor-pointer" onClick={() => profile && setGameState('MENU')}>
                                        <span className="font-black text-2xl tracking-tight">單字大師</span>
                                        {profile && <span className="text-xs font-bold text-slate-600 bg-slate-100 px-2 py-0.5 rounded-lg w-fit">{profile.username}</span>}
                                    </div>
                                </div>
                                
                                {profile && (
                                    <div className="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 hidden md:flex flex-col items-center animate-in zoom-in">
                                        <div className="flex items-center gap-3 bg-gradient-to-r from-amber-400 to-amber-600 text-white px-8 py-2.5 rounded-full shadow-[0_6px_0_rgb(180,83,9)] border-4 border-white dark:border-slate-800 transform hover:scale-105 transition-all cursor-pointer">
                                            <Coins size={36} className="fill-yellow-200 text-yellow-100" />
                                            <span className="font-black text-4xl tracking-wider drop-shadow-md">{userTokens}</span>
                                        </div>
                                    </div>
                                )}

                                <div className="flex items-center gap-2 z-10">
                                    {profile && (
                                        <>
                                            <button onClick={() => setGameState('SHOP')} className="p-2.5 rounded-xl bg-white dark:bg-slate-800 border-b-2 border-slate-200 dark:border-slate-700 hover:bg-slate-50 text-blue-500" title="商店"><ShoppingBag size={20} /></button>
                                            <button onClick={() => setGameState('ACHIEVEMENTS')} className="p-2.5 rounded-xl bg-white dark:bg-slate-800 border-b-2 border-slate-200 dark:border-slate-700 hover:bg-slate-50 text-amber-500" title="成就"><Trophy size={20} /></button>
                                        </>
                                    )}
                                    <button onClick={toggleDarkMode} className="p-2.5 rounded-xl bg-white dark:bg-slate-800 border-b-2 border-slate-200 dark:border-slate-700">{isDarkMode ? <Sun size={20} /> : <Moon size={20} />}</button>
                                    {profile && (
                                        <div className="md:hidden flex items-center gap-2 bg-amber-100 border-2 border-amber-200 px-3 py-1.5 rounded-full">
                                            <Coins size={20} className="text-amber-500" />
                                            <span className="font-black text-amber-700 text-lg">{userTokens}</span>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </header>

                        <main className="flex-1 flex flex-col relative p-6">
                            {gameState === 'PROFILE_SETUP' && (
                                <div className="flex-1 flex flex-col items-center justify-center animate-in fade-in">
                                    <div className="bg-white dark:bg-slate-900 p-8 rounded-3xl shadow-2xl border-4 border-slate-200 max-w-lg w-full text-center">
                                        <div className="w-20 h-20 bg-blue-100 rounded-3xl flex items-center justify-center text-blue-500 mx-auto mb-6"><LogIn size={40} /></div>
                                        <h2 className="text-3xl font-black mb-4">歡迎回來，英雄</h2>
                                        <input type="text" value={tempUsername} onChange={e => setTempUsername(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleLogin()} placeholder="輸入你的名字" className="w-full bg-slate-100 border-2 border-slate-300 rounded-2xl px-6 py-4 font-bold text-lg mb-6 placeholder-slate-400 focus:border-blue-500 focus:bg-white transition-all" />
                                        <Button onClick={handleLogin} className="w-full text-xl" disabled={!tempUsername.trim()}>開始冒險</Button>
                                    </div>
                                </div>
                            )}

                            {gameState === 'MENU' && (
                                <div className="flex-1 flex flex-col items-center justify-center max-w-4xl mx-auto w-full">
                                    <h1 className="text-5xl md:text-6xl font-black text-blue-900 dark:text-blue-400 mb-12 text-center">Spelling Bee <span className="text-blue-500">3C</span></h1>
                                    <div className="grid md:grid-cols-2 gap-6 w-full">
                                        {[1, 2, 3, 4].map(part => (
                                            <div key={part} onClick={() => startGame(part)} className="bg-white/90 dark:bg-slate-900/90 p-8 rounded-3xl border-4 border-slate-200 dark:border-slate-800 hover:border-blue-400 hover:scale-[1.02] transition-all cursor-pointer flex items-center gap-4 shadow-sm">
                                                <div className={`p-4 rounded-2xl ${['bg-blue-100 text-blue-600', 'bg-rose-100 text-rose-600', 'bg-emerald-100 text-emerald-600', 'bg-amber-100 text-amber-600'][part-1]}`}><Library size={32} /></div>
                                                <div><h3 className="text-2xl font-black">Grade 3C - Part {part}</h3><p className="text-slate-600 dark:text-slate-400 font-bold text-sm">點擊開始練習</p></div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {gameState === 'PLAYING' && (
                                <DictationGame words={words} onFinish={handleGameFinish} onExit={() => setGameState('MENU')} onTokenEarned={() => setUserTokens(getUserTokens())} />
                            )}

                            {gameState === 'SHOP' && (
                                <ShopView onBack={() => setGameState('MENU')} onUpdateTokens={() => setUserTokens(getUserTokens())} />
                            )}

                            {gameState === 'ACHIEVEMENTS' && (
                                <AchievementsView onBack={() => setGameState('MENU')} />
                            )}

                            {gameState === 'SUMMARY' && gameStats && (
                                <div className="flex-1 flex flex-col items-center justify-center animate-in zoom-in">
                                    <div className="bg-white dark:bg-slate-900 max-w-2xl w-full rounded-3xl shadow-2xl p-12 text-center border-4 border-slate-200">
                                        <h2 className="text-3xl font-black mb-8">任務完成！</h2>
                                        <div className="grid grid-cols-3 gap-4 mb-8">
                                            <div className="p-4 bg-blue-50 rounded-2xl border-2 border-blue-100"><div className="text-2xl font-black text-blue-500">{gameStats.correct}/{gameStats.total}</div><div className="text-xs font-bold text-blue-500">分數</div></div>
                                            <div className="p-4 bg-emerald-50 rounded-2xl border-2 border-emerald-100"><div className="text-2xl font-black text-emerald-500">+{gameStats.correct * 10}</div><div className="text-xs font-bold text-emerald-500">代幣</div></div>
                                            <div className="p-4 bg-slate-50 rounded-2xl border-2 border-slate-200"><div className="text-2xl font-black text-slate-600">{Math.round((gameStats.correct/gameStats.total)*100)}%</div><div className="text-xs font-bold text-slate-500">正確率</div></div>
                                        </div>
                                        <div className="flex gap-4">
                                            <Button onClick={() => setGameState('MENU')} variant="secondary" className="flex-1">回主選單</Button>
                                            <Button onClick={() => setGameState('PLAYING')} className="flex-1">再次挑戰</Button>
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            {gameState === 'PROFILE' && (
                                <div className="flex-1 flex flex-col items-center justify-center">
                                    <div className="bg-white dark:bg-slate-900 p-8 rounded-3xl shadow-2xl border-4 border-slate-200 max-w-lg w-full">
                                        <h2 className="text-2xl font-black mb-6 flex items-center gap-2"><User /> 英雄檔案</h2>
                                        <div className="space-y-4">
                                            <p className="font-bold text-slate-600">英雄名稱: <span className="text-slate-800 dark:text-white">{profile.username}</span></p>
                                            <div className="grid grid-cols-5 gap-2">
                                                {AVATARS.filter(a => ['user','cat','dog','bird','rabbit','smile'].includes(a.id) || profile.purchasedItemIds?.includes(a.id)).map(a => (
                                                    <button key={a.id} onClick={() => {
                                                        const updated = {...profile, avatarId: a.id};
                                                        saveUserProfile(updated);
                                                        setProfile(updated);
                                                    }} className={`aspect-square rounded-xl flex items-center justify-center text-white ${a.color} ${profile.avatarId === a.id ? 'ring-4 ring-offset-2 ring-blue-500' : 'opacity-50'}`}>
                                                        <a.icon size={20} />
                                                    </button>
                                                ))}
                                            </div>
                                            <div className="pt-6 flex gap-4">
                                                <Button onClick={() => setGameState('MENU')} variant="secondary" className="flex-1">返回</Button>
                                                <button onClick={() => { logoutUser(); setProfile(null); setGameState('PROFILE_SETUP'); }} className="flex-1 py-3 rounded-xl font-bold border-2 border-rose-200 text-rose-500 hover:bg-rose-50 transition-colors">登出</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </main>
                    </div>
                );
            };

            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<App />);
            
        } catch (err) {
            console.error(err);
            document.body.innerHTML += '<div style="color:red;padding:20px;">Render Error: ' + err.message + '</div>';
        }
    </script>
</body>
</html>
